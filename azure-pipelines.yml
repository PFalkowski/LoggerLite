trigger:
  branches:
    include:
    - master
  paths:
    include:    
    - 'azure-pipelines.yml'
    exclude: 
    - 'README.md'
    - '*.png'
    - '*.txt'

pool:
  name: Hosted VS2017
  demands:
  - msbuild
  - visualstudio
  - vstest

steps:
- task: NuGetToolInstaller@0
  displayName: 'Use NuGet 4.4.1'
  inputs:
    versionSpec: 4.4.1

#- task: NuGetCommand@2
#  displayName: 'NuGet restore'
#  inputs:
#    restoreSolution: '**\*.sln'

# .NET Core
# Restore NuGet packages.
- task: DotNetCoreCLI@2
  displayName: 'NuGet Restore'
  inputs:
    command: 'restore'
    solution: '**\*.sln'


#- task: DotNetCoreCLI@2
#  displayName: 'Build solution'
#  inputs:
#    command: 'build'
#    solution: '**\*.sln'
#    configuration: 'Debug'
#    platform: 'Any CPU'

# because of open bug, need to build using VSBuild@1 task. ref: https://github.com/Microsoft/msbuild/issues/2221

- task: VSBuild@1
  displayName: 'Build solution'
  inputs:
    solution: '**\*.sln'
    platform: 'Any CPU'
    configuration: 'Debug'
    maximumCpuCount: true

# Run tests and create coverage report
- task: DotNetCoreCLI@2
  displayName: Test assemblies
  inputs:
    command: test
    projects: ./LoggerLite.xTest/LoggerLite.xTest.csproj
    arguments: '--configuration Debug --no-build /p:AltCover=true /p:AltCoverForce=true /p:CoverletOutputFormat=opencover /p:AltCoverCallContext=[Fact] /p:AltCoverXmlReport=.\coverage.opencover.xml'

- script: |
    mkdir $(Build.SourcesDirectory)\results
    dotnet test --configuration Debug --logger trx /p:CollectCoverage=true /p:CoverletOutputFormat=opencover LoggerLite.xTest
    opencover.console.exe -register:user -target:"C:/Program Files/dotnet/dotnet.exe" -targetargs:"test LoggerLite.xTest" -output:"coverage.opencover.xml"
    copy $(Build.SourcesDirectory)\LoggerLite.xTest\coverage.opencover.xml $(Build.SourcesDirectory)\results
  displayName: 'Unit testing'

# Upload coverage to codecov.io
- script: | 
    %USERPROFILE%\.nuget\packages\codecov\1.3.0\tools\codecov.exe -f "./LoggerLite.xTest/TestResults/coverage.opencover.xml" -t $(CODECOV_TOKEN)
  displayName: 'Upload coverage to codecov.io'
  failOnStderr: false